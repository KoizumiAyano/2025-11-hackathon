<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ランキング</title>
    <link rel="stylesheet" href="src/style.css?v=3">
    <style>
      /* simple overrides for ranking layout */
      #rankingRoot { padding: 20px; color: var(--muted-yellow); }
      .rank-item { display:flex; gap:12px; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.04); }
      .rank-item .rank-num { font-weight:700; width:36px; text-align:center; }
      .rank-item .rank-info { flex:1; }
  /* back button style moved to src/style.css */
    </style>
  </head>
  <body class="ranking">
    <button class="back-btn" onclick="location.href='index.html'">← 戻る</button>
    <main id="rankingRoot">
      <h1>ランキング</h1>
      <p id="summary"></p>
      <div id="list"></div>
    </main>

    <script>
      (function(){
        const API_URL = 'http://127.0.0.1:8001';
        const listEl = document.getElementById('list');
        const summary = document.getElementById('summary');
        async function load() {
          try {
            const res = await fetch(API_URL + '/posts/');
            if (!res.ok) throw new Error('投稿取得失敗');
            const posts = await res.json();
            if (!Array.isArray(posts)) return;
              // sort first by parm_unluckey (降順: 5 -> 1), then by like_count (降順)
              posts.sort((a, b) => {
                const ra = Number(a.parm_unluckey || 0);
                const rb = Number(b.parm_unluckey || 0);
                if (rb !== ra) return rb - ra; // higher parm_unluckey first
                return (b.like_count || 0) - (a.like_count || 0); // then by likes
              });
            summary.textContent = `全 ${posts.length} 件`; 
            posts.forEach((p,i) => {
              const d = document.createElement('div');
              d.className = 'rank-item';
              const unluck = Number(p.parm_unluckey || 0);
              d.innerHTML = `
                <div class="rank-num">#${i+1}</div>
                <div class="rank-info">
                  <div>
                    <strong>${escapeHtml(p.name||'匿名')}</strong>
                    <small>（いいね ${p.like_count||0} ・ 不幸指数 ${unluck}）</small>
                  </div>
                  <div style="opacity:.9">${escapeHtml(p.content||'')}</div>
                </div>
              `;
              listEl.appendChild(d);
            });
          } catch (e) {
            listEl.textContent = '読み込みに失敗しました: ' + e.message;
          }
        }
        function escapeHtml(str){ return String(str).replace(/[&<>"]/, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }
        load();
      })();
    </script>
  </body>
 </html>
